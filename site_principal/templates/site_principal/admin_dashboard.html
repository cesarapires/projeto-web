{% extends 'base.html' %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Admin Dashboard</h2>
  </div>

  <div class="mt-3">
    <a href="{% url 'admin_orcamento_create' %}" class="btn btn-success me-2">Novo Orçamento</a>
    <a href="{% url 'peca_list' %}" class="btn btn-secondary ms-2">Gerenciar Peças</a>
  </div>

  <hr class="my-4">

  <div class="accordion" id="ordensAccordion">
    <!-- Aberta -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingAberta">
        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAberta" aria-expanded="true" aria-controls="collapseAberta">
          Orçamentos Abertos ({{ ordens_abertas.count }})
        </button>
      </h2>
      <div id="collapseAberta" class="accordion-collapse collapse show" aria-labelledby="headingAberta" data-bs-parent="#ordensAccordion">
        <div class="accordion-body">
          {% if ordens_abertas %}
            <div class="table-responsive">
              <table class="table table-sm table-striped">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Veículo</th>
                    <th>Cliente</th>
                    <th>Valor</th>
                    <th>Aberto em</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody>
                  {% for o in ordens_abertas %}
                    <tr>
                      <td>{{ o.id }}</td>
                      <td>{{ o.veiculo.placa }} — {{ o.veiculo.modelo }}</td>
                      <td>{{ o.veiculo.cliente.user.username }}</td>
                      <td>R$ {{ o.valor_total }}</td>
                      <td>{{ o.data_abertura|date:"SHORT_DATETIME_FORMAT" }}</td>
                      <td>
                        <button class="btn btn-sm btn-outline-secondary btn-view" data-url="{% url 'admin_orcamento_detail' o.id %}">Visualizar</button>
                        <a href="{% url 'admin_orcamento_edit' o.id %}" class="btn btn-sm btn-outline-primary ms-1">Editar</a>
                        <a href="{% url 'admin_orcamento_delete' o.id %}" class="btn btn-sm btn-outline-danger ms-1">Deletar</a>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="mb-0">Nenhum orçamento aberto.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Em andamento -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingAndamento">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAndamento" aria-expanded="false" aria-controls="collapseAndamento">
          Orçamentos em andamento ({{ ordens_andamento.count }})
        </button>
      </h2>
      <div id="collapseAndamento" class="accordion-collapse collapse" aria-labelledby="headingAndamento" data-bs-parent="#ordensAccordion">
        <div class="accordion-body">
          {% if ordens_andamento %}
            <div class="table-responsive">
              <table class="table table-sm table-striped">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Veículo</th>
                    <th>Cliente</th>
                    <th>Valor</th>
                    <th>Aberto em</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody>
                  {% for o in ordens_andamento %}
                    <tr>
                      <td>{{ o.id }}</td>
                      <td>{{ o.veiculo.placa }} — {{ o.veiculo.modelo }}</td>
                      <td>{{ o.veiculo.cliente.user.username }}</td>
                      <td>R$ {{ o.valor_total }}</td>
                      <td>{{ o.data_abertura|date:"SHORT_DATETIME_FORMAT" }}</td>
                      <td>
                        <button class="btn btn-sm btn-outline-secondary btn-view" data-url="{% url 'admin_orcamento_detail' o.id %}">Visualizar</button>
                        <a href="{% url 'admin_orcamento_edit' o.id %}" class="btn btn-sm btn-outline-primary ms-1">Editar</a>
                        <a href="{% url 'admin_orcamento_delete' o.id %}" class="btn btn-sm btn-outline-danger ms-1">Deletar</a>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="mb-0">Nenhum orçamento em andamento.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Aguardando aprovação -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingAguardando">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAguardando" aria-expanded="false" aria-controls="collapseAguardando">
          Orçamentos aguardando aprovação ({{ ordens_aguardando.count }})
        </button>
      </h2>
      <div id="collapseAguardando" class="accordion-collapse collapse" aria-labelledby="headingAguardando" data-bs-parent="#ordensAccordion">
        <div class="accordion-body">
          {% if ordens_aguardando %}
            <div class="table-responsive">
              <table class="table table-sm table-striped">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Veículo</th>
                    <th>Cliente</th>
                    <th>Valor</th>
                    <th>Aberto em</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody>
                  {% for o in ordens_aguardando %}
                    <tr>
                      <td>{{ o.id }}</td>
                      <td>{{ o.veiculo.placa }} — {{ o.veiculo.modelo }}</td>
                      <td>{{ o.veiculo.cliente.user.username }}</td>
                      <td>R$ {{ o.valor_total }}</td>
                      <td>{{ o.data_abertura|date:"SHORT_DATETIME_FORMAT" }}</td>
                      <td>
                        <button class="btn btn-sm btn-outline-secondary btn-view" data-url="{% url 'admin_orcamento_detail' o.id %}">Visualizar</button>
                        <a href="{% url 'admin_orcamento_edit' o.id %}" class="btn btn-sm btn-outline-primary ms-1">Editar</a>
                        <a href="{% url 'admin_orcamento_delete' o.id %}" class="btn btn-sm btn-outline-danger ms-1">Deletar</a>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="mb-0">Nenhum orçamento aguardando aprovação.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Finalizadas -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingFinalizadas">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFinalizadas" aria-expanded="false" aria-controls="collapseFinalizadas">
          Orçamentos finalizados ({{ ordens_finalizadas.count }})
        </button>
      </h2>
      <div id="collapseFinalizadas" class="accordion-collapse collapse" aria-labelledby="headingFinalizadas" data-bs-parent="#ordensAccordion">
        <div class="accordion-body">
          {% if ordens_finalizadas %}
            <div class="table-responsive">
              <table class="table table-sm table-striped">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Veículo</th>
                    <th>Cliente</th>
                    <th>Valor</th>
                    <th>Aberto em</th>
                    <th>Fechado em</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody>
                  {% for o in ordens_finalizadas %}
                    <tr>
                      <td>{{ o.id }}</td>
                      <td>{{ o.veiculo.placa }} — {{ o.veiculo.modelo }}</td>
                      <td>{{ o.veiculo.cliente.user.username }}</td>
                      <td>R$ {{ o.valor_total }}</td>
                      <td>{{ o.data_abertura|date:"SHORT_DATETIME_FORMAT" }}</td>
                      <td>{{ o.data_fechamento|date:"SHORT_DATETIME_FORMAT" }}</td>
                      <td>
                        <button class="btn btn-sm btn-outline-secondary btn-view" data-url="{% url 'admin_orcamento_detail' o.id %}">Visualizar</button>
                        <a href="{% url 'admin_orcamento_edit' o.id %}" class="btn btn-sm btn-outline-primary ms-1">Editar</a>
                        <a href="{% url 'admin_orcamento_delete' o.id %}" class="btn btn-sm btn-outline-danger ms-1">Deletar</a>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="mb-0">Nenhum orçamento finalizado.</p>
          {% endif %}
        </div>
      </div>
    </div>

  </div>
  {# end accordion #}
  <!-- Modal para visualizar detalhes da ordem -->
  <div class="modal fade" id="orcamentoDetailModal" tabindex="-1" aria-labelledby="orcamentoDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="orcamentoDetailModalLabel">Orçamento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <!-- conteúdo será carregado via fetch -->
          <div id="orcamentoDetailContent">Carregando...</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const modalEl = document.getElementById('orcamentoDetailModal');
      const modal = new bootstrap.Modal(modalEl);
      const content = document.getElementById('orcamentoDetailContent');

      document.querySelectorAll('.btn-view').forEach(btn => {
        btn.addEventListener('click', function (e) {
          const url = btn.getAttribute('data-url');
          if (!url) return;
          content.innerHTML = 'Carregando...';
          fetch(url, {headers: {'X-Requested-With': 'XMLHttpRequest'}})
            .then(resp => resp.text())
            .then(html => {
              content.innerHTML = html;
              modal.show();
            })
            .catch(err => {
              content.innerHTML = '<div class="text-danger">Erro ao carregar detalhes.</div>';
              modal.show();
            });
        });
      });

      // Se houver ?open_order=<id> na querystring, abrir automaticamente o modal para essa ordem
      const params = new URLSearchParams(window.location.search);
      const openOrder = params.get('open_order');
      if (openOrder) {
        const detailUrlTemplate = "{% url 'admin_orcamento_detail' 0 %}"; // ex: /dashboard/admin/orcamentos/0/
        const detailUrl = detailUrlTemplate.replace('/0/', `/${openOrder}/`);
        content.innerHTML = 'Carregando...';
        fetch(detailUrl, {headers: {'X-Requested-With': 'XMLHttpRequest'}})
          .then(resp => resp.text())
          .then(html => {
            content.innerHTML = html;
            modal.show();
            // Remover o param para evitar reabrir se o usuário recarregar
            params.delete('open_order');
            const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
            window.history.replaceState({}, '', newUrl);
          })
          .catch(err => {
            content.innerHTML = '<div class="text-danger">Erro ao carregar detalhes.</div>';
            modal.show();
          });
      }
    });
  </script>
{% endblock %}
